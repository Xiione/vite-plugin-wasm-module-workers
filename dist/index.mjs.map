{"version":3,"sources":["../src/index.ts"],"sourcesContent":["// @ts-check\nimport * as path from 'path'\nimport * as fs from 'fs'\n\nimport type { Plugin } from 'vite'\nimport { ResolvedConfig } from 'vite'\ntype LoadResult = string | null\n\nexport default function wasmModuleWorkers(): Plugin {\n  const postfix = '.wasm?module'\n  let isDev = false\n\n  return {\n    name: 'vite:wasm-helper',\n    configResolved(config: ResolvedConfig) {\n      isDev = config.command === 'serve'\n    },\n    config() {\n      return { build: { rollupOptions: { external: /.+\\.wasm?url$/i } } }\n    },\n    renderChunk(code: string) {\n      if (isDev) return\n      if (!/.*\\?module.*/g.test(code)) return\n\n      let final = code.replaceAll(/(const\\s+(\\w+))(.*\\.wasm.*)/gm, (s) => {\n        return s.replace(/const\\s+(\\w+)\\s*=\\s*\"(.*)\"/, 'import $1 from \".$2\"')\n      })\n\n      final = final.replaceAll(/const\\n*.*{\\n*.*default:(\\n|.)*?(;)/gm, (s) => {\n        return s.replace(\n          /[\\s\\S]*?(?=:\\s):\\s(\\w+)[\\s\\S]*?(?=\\{){(.*?)}[\\s\\S]*?(?:\\);*)/gm,\n          `const $1 = $2`\n        )\n      })\n\n      return { code: final }\n    },\n    load(id: string): LoadResult {\n      if (!id.endsWith(postfix)) {\n        return null\n      }\n\n      const filePath = id.slice(0, -1 * '?module'.length)\n\n      if (isDev) {\n        return `\n            import fs from \"fs\"\n    \n            const wasmModule = new WebAssembly.Module(fs.readFileSync(\"${filePath}\"));\n            export default wasmModule;\n            `\n      }\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const assetId = this.emitFile({\n        type: 'asset',\n        name: path.basename(filePath),\n        source: fs.readFileSync(filePath),\n      })\n\n      return `\n          import init from \"__WASM_ASSET__${assetId}.wasm\"\n          export default init\n          `\n    },\n  }\n}\n"],"mappings":";AACA,YAAY,UAAU;AACtB,YAAY,QAAQ;AAML,SAAR,oBAA6C;AAClD,QAAM,UAAU;AAChB,MAAI,QAAQ;AAEZ,SAAO;AAAA,IACL,MAAM;AAAA,IACN,eAAe,QAAwB;AACrC,cAAQ,OAAO,YAAY;AAAA,IAC7B;AAAA,IACA,SAAS;AACP,aAAO,EAAE,OAAO,EAAE,eAAe,EAAE,UAAU,iBAAiB,EAAE,EAAE;AAAA,IACpE;AAAA,IACA,YAAY,MAAc;AACxB,UAAI;AAAO;AACX,UAAI,CAAC,gBAAgB,KAAK,IAAI;AAAG;AAEjC,UAAI,QAAQ,KAAK,WAAW,iCAAiC,CAAC,MAAM;AAClE,eAAO,EAAE,QAAQ,8BAA8B,sBAAsB;AAAA,MACvE,CAAC;AAED,cAAQ,MAAM,WAAW,yCAAyC,CAAC,MAAM;AACvE,eAAO,EAAE;AAAA,UACP;AAAA,UACA;AAAA,QACF;AAAA,MACF,CAAC;AAED,aAAO,EAAE,MAAM,MAAM;AAAA,IACvB;AAAA,IACA,KAAK,IAAwB;AAC3B,UAAI,CAAC,GAAG,SAAS,OAAO,GAAG;AACzB,eAAO;AAAA,MACT;AAEA,YAAM,WAAW,GAAG,MAAM,GAAG,KAAK,UAAU,MAAM;AAElD,UAAI,OAAO;AACT,eAAO;AAAA;AAAA;AAAA,yEAG0D,QAAQ;AAAA;AAAA;AAAA,MAG3E;AAGA,YAAM,UAAU,KAAK,SAAS;AAAA,QAC5B,MAAM;AAAA,QACN,MAAW,cAAS,QAAQ;AAAA,QAC5B,QAAW,gBAAa,QAAQ;AAAA,MAClC,CAAC;AAED,aAAO;AAAA,4CAC+B,OAAO;AAAA;AAAA;AAAA,IAG/C;AAAA,EACF;AACF;","names":[]}